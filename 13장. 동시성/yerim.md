# 13장 동시성

## ****동시성이 필요한 이유****

concurrency가 여러 유저를 동시에 처리함으로써 처리량을 향상시킬 수 있다.

### 미신과 오해

- Concurrency는 항상 퍼포먼스를 향상시킨다.
⇒ 여러 스레드 혹은 여러 프로세서가 대기 시간을 공유할 수 있는 경우에만! 
하지만 이러한 경우는 드물다.
- Concurrent program 작성은 시스템의 디자인을 변경시키지 않는다.
⇒"무엇"과 "언제"를 분리하는 작업은 보통 시스템의 구조에 큰 영향을 미친다.
- Web나 EJB와 같은 컨테이너를 사용한다면 Concurrency 문제들은 신경쓸 필요가 없다.
⇒ 컨테이너가 어떤 일을 하는가에 대해 알아야 하며 concurrent update, 데드락을 해결하는 방법을 알아야 한다.

### Concurrency의 문제점

- 퍼포먼스, 코드 작성 양쪽 모두에 약간의 오버헤드를 일으킨다.
- 간단한 문제 해결을 위한 Concurrency는 간단하지 않다.
- Concurrency 관련 버그는 재현하기 어렵기 때문에 종종 one-off로 취급된다.
    - on-off : 한 번만 일어나는, 한 번만 일어나는
- Concurrency 문제는 보통 근본적인 디자인 개편이 필요하다.

### **동기화하는 부분을 작게 만들어라**

Synchronized로 수행되는 잠금은 딜레이 & 오버헤드를 만들기 때문에 "비싼 수행"으로 가능한 한 작게 만들어야 한다. 반면 critical section은 꼭 보호되어야 한다.

## ****스레드 코드 테스트하기****

*문제를 발생시킬 만한 테스트를 작성하고 여러 프로그램 설정과 시스템 설정, 부하 하에서 자주 수행하라. 테스트가 한번이라도 실패한다면 원인을 분석하라. 한번 더 테스트를 실행해 성공했다고 해서 이전의 실패를 무시하지 마라.*

- 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라
    - 일반적으로 발생할 리 없어 보이는 문제를 발생시킨다.  on-off로 치부.
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자
    - 스레드 밖에서 잘 동작하는 코드를 먼저 작성하라
- 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있게 스레드 코드를 구현하라
- 다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율할 수 있게 작성하라
- 프로세서 수보다 많은 스레드를 돌려보라
- 다른 플랫폼에서 돌려보라
    - os바꿔보고, 여러 환경에서 테스트
- 코드에 보조 코드instrument를 넣어 돌려라. 강제로 실패를 일으키게 해보라

Concurrent 코드는 제대로 작성하기 어렵지만 작성하게 된다면 엄격한 기준으로 clean하게 작성하라.

한 공유 자원에 대한 멀티 스레드 수행, 공유되는 자원 풀 등 concurrency 문제를 일으킬 수 있는 부분에 대해 인지하라.